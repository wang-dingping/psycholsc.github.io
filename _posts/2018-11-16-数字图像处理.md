---
layout: post
title:  "数字图像处理"
excerpt: "数字图像处理简要提纲"
date:   2018-11-16 23:54:54 +0000
categories: Notes
comments: true
---

<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

# 数字图像处理

- 期末考试**60**分
- 平时成绩**40**分
- 参考资料 - 冈萨雷斯《数字图像处理》

## 第一章 绪论

1. 数字图像处理的主要内容（基本步骤）

    课程涵盖内容主要包括图像的获取与表示，图像增强，图像复原，压缩编码，图像分割，图像分析。

    数字图像处理一般包含**图像采集（模拟图像的数字化）**，**图像重建**，**图像变换**、**滤波、增强、复原、拼接**等，**图像的压缩与编码**，图像的数字水印和信息隐藏等。

    数字图像分析一般包含边缘检测，图像分割，目标表达、描述、测量，目标形状纹理运动等分析、目标检测提取跟踪识别分类等

    图像理解不在课程要求内。

    课本中描述为：

    图像获取、图像滤波与增强、图像复原、彩色图像处理、小波域多分辨率处理、压缩、形态学处理、分割、表示与描述、目标识别。

2. 根据成像信息源，数字图像处理的主要应用有哪些（电磁波不同波段成像的特点与应用）

    数字图像有将度高，可重复性好，通用性、灵活性强等优点。

    - 伽马射线成像

        核医学、天文观测。医学中人摄入放射性同位素后，在其衰变过程中就会放射伽马射线，以此可以做伽马射线成像。可用于判断骨骼病变位置，感染或肿瘤等。

    - X射线成像

        医学诊断、工业以及其他领域。X射线穿透需要成像的物体后发生衰减，落在底片上之后感光成像。工业应用有电路缺陷检测、金属元件探伤等。

    - 紫外波段成像

        紫外光谱应用较多，平板印刷、工业检测、显微方法、天文观测、生物成像等。常见应用有紫外荧光显微方法以及紫外成像的天文摄影等。

    - 可见光以及红外波段成像

        天文、遥感等领域应用。制药工艺中常会采用可见光的显微技术观测，而遥感中常用红外。还有天气观测等其他应用。

    - 微波波段成像

        雷达成像。一些波段的微波容易穿透云层，从而达到探测与成像等效果。

    - 无线电波段成像

        医学与天文学。核磁共振中常用此类技术。

    - **其他成像**

        声音成像（B超、地质探测、海洋探测），电子成像（电子显微镜）。

## 第二章 数字图像基础

1. 图象数字化包括哪两个过程？数字化参数对图像质量有何影响？

    采样与量化。在满足采样定理的条件下，图像损失较少。量化过程中采用了256量化级数，将连续信息保存到离散点上的离散值。图像信息在此处会被叠加噪声（量化噪声）。采样点数越多，其分辨率越高，数字图像的质量也越高。

2. 人眼中两类光感受细胞锥状体细胞与杆状体细胞的主要功能与特点？

    视锥细胞和视杆细胞都是视网膜上的光感受器，其中视锥细胞在每只眼中约有600万-700万个，主要位于视野的中央凹位置，对颜色高度敏感，可以充分分辨图像的细节，眼球的转动不会对视锥细胞的位置产生影响；视杆细胞大约有7500万到15000万个，主要用于给出视野内的总体图像，但是不感知色彩，对低照度敏感，分布范围较大，但是多个细胞共用一个神经末梢，导致其分辨能力较差。

3. 白天进入一个黑暗剧场的时候，想要看清并找到空座位时眼睛需要适应一段时间，试图描述发生这种现象的视觉原理。

    白天光照较强，此时主要是视锥细胞起主要的视觉作用（视锥细胞对高亮度敏感，对色彩敏感），称为白昼视觉或亮视觉；而视杆细胞主要对低亮度敏感，因此在白天时并不起主要作用，称为暗视觉或微光视觉。白天进入黑暗的剧场时，由于视觉并不能同时在大范围内工作，因此起主要作用的视锥细胞会渐渐失去作用，视杆细胞逐渐开始起主要作用。这个切换过程需要一定时间，因此需要适应一段时间。

4. 图像的形成模型；**同态滤波**

    人眼中图像的生成主要依赖于人眼的类凸透镜成像和人眼对可见光的反应。

    用函数$$f(x,y)$$来表示图像，其中$$f$$是正标量0-255。一般的其物理意义由像源决定，$$f$$可以由两个分量来表征

    - 入射分量 - 入射到被观察场景的光源照射总量
    - 反射分量 - 场景中物体所反射的光照总量

    单位都是流明（照度）。

    $$f(x,y)=i(x,y)r(x,y)$$

    入射分量可以是0到无穷之间变化，反射分量是一个相对数值，在0到1之间变化。

    其中照射分量描述景物的照度，变化较缓慢，处于低频成分，反射分量用于描述景物的细节，变化较快，处于高频成分区。

    因为该性质是乘性的，因此不能直接使用傅里叶变换对其进行控制，而可以选择使用对数先将乘性量分离，然后处理加性量。

    *为了防止取值到log(0)，常会采用加一取对数的方法*

    对数后的结果取傅里叶变换，得到

    $$Z(u,v)=Fi(u,v)+Fr(u,v)$$

    然后使用一个滤波器对其进行滤波，可以得到

    $$S(u,v)=H(u,v)Z(u,v)=H(u,v)Fi(u,v)+H(u,v)Fr(u,v)$$

    滤波后做反变换可以得到

    $$s(x,y)=IDFT[S(u,v)]$$

    最后对结果进行指数变换，得到最终处理的图像为

    $$g(x,y)=e^{s(x,y)}=i_{filtered}(x,y)+r_{filtered}(x,y)$$

    *如果前面做了+1处理，这里要记得-1*

    而对于滤波器部分，如果我们想要增强暗区域的细节，则可以认为是光照不均匀造成的，为减少光照影响，就可以增强图像的高频成分，设计高通滤波器。

    以上操作就是**同态滤波**。

    视网膜将图像聚集在中央凹附近，光接收器对光的刺激产生感知，把辐射转变为电脉冲，经大脑解码生成图像。

5. 马赫带现象、对比度、空间、灰度分辨率

    奥地利物理学家马赫发现的视觉效应，观察两块亮度不同的区域时，边界处亮度对比加强，使轮廓表现得特别明显。

    对比度是一幅图像中明暗区域**最亮的白和最暗的黑**之间的比值。

    空间分辨率是图像中可分辨的最小细节度量。数量上有很多方法来说明。

    灰度分辨率，灰度级中可分辨的最小变化。一般是2的整数次幂。通用的是8bit，但是在一些特殊用途中也会出现16bit。

6. 为什么大口径镜头的照相机成像清晰？（其他工艺水平相同的情况下）

    CCD传感器阵列中，每个传感器的响应正比于投射到传感器表面的总能量，提高口径就可以增大单位时间内投射到表面的能量，从而降低噪声。

7. 4邻域、8邻域、**视觉感知要素**、人眼对亮度的适应范围；视觉错觉；电磁波不同波段成像特点

    一个点和上下左右四个点被称为4邻域

    一个点和四个角的四个相邻点被称为8邻域

    **视觉感知要素**一般指人眼结构、人眼生成图像、亮度的适应和辨别等。

    人眼对亮度的适应范围很宽，大约有$$10^{10}$$量级（最低暗阈值到瞬时强闪光）。主观亮度是进入人眼的光强的对数函数。

    亮视觉中人眼适应范围约为$$10^6$$。

    视觉系统不能同时在一个范围内工作，确切的说人眼是通过改变整个灵敏度来完成较大亮度适应性的（**亮度适应现象**）。当人眼处在一定的亮度适应性内时，实际上动态范围较小。

## 第三章 空间域图像增强

1. **空间域**滤波与**频率域**滤波的特点分别为什么？常用的滤波器有哪些？

    空间域滤波是对图像本身的像素进行处理，频率域滤波是对图像的傅里叶变换做处理。所有的变换域处理都首先将图像变换到另一个域中，然后才进行处理，并通过反变换将结果返回空间域。

    空间域滤波后的图像，其每一点的像素值不仅与原图像的该点有关，还和其邻域的像素有关（因为其处理方式是通过一个n*m的窗进行滑动）。

    常用空间域滤波器分为线性滤波器和非线性滤波器，线性滤波器又可分为低通带通与高通滤波器，非线性滤波器较多，常用的有最小值、中值、最大值滤波器等

    按处理效果还可以分为平滑滤波和锐化滤波。

2. 基本的灰度变换函数

    - 反转曲线是一条向下的斜线，作用是将灰度级做反相，处理方程为$$s=L-1-r$$。课本举例为反相分析人体组织，结果更易分辨。

    - 对数处理方程为$$s=clog(1+r)$$，将输入中范围较窄的低灰度值映射到较宽的范围内，而将较宽的高灰度值映射到较窄的范围内。具有该类型特征的曲线都可以叫对数型变换（例如n次根）。课本举例为丰富频谱的细节。

    - 幂次（伽马）$$s=cr^\gamma$$变换。有时也会做一个小的偏移。实际上的效果也是将窄带到宽带映射或从宽带到窄带映射。由于获取图像的设备（CRT、扫描仪、放射仪、航空图像等）往往是幂律响应，因此往往需要伽马校正，做一个与设备相反的响应的变换就能获取真正的数字图像。
    - 对比度拉伸函数，一个逼近阈值函数的S型函数，可以将低输入压缩到很低输出，将高输入拉伸到很高输出
    - 阈值处理就是一个竖线。处理出来就是二值图了。
    - 分段线性变换，很多用法，比如对比度拉伸、灰度级分层（一般是凸字形的函数或类似凸字形函数）比特平面分层等

3. 灰度直方图是什么，有哪些应用

    常用直方图来描述灰度分布，归一化直方图的所有分量之和一般为1，实际上就是个概率分布，但是不包含位置信息。灰度直方图用于描述灰度的分布，对直方图的处理常用与图像增强等领域。

    用途在PPT描述如下

    1. 评价成像条件：根据图像灰度直方图可以分析图像在成像过程中（或数字化过程中）是否合理利用了灰度的动态范围
    2. 图像增强处理，根据直方图应用映射函数使处理后的图像能够充分利用灰度的动态范围
    3. 图像分割：根据图像的灰度直方图，将像素分割成不同的类别，实现不同景物的提取。
    4. 图像压缩：利用其统计信息，可以进行呢编码（例如霍夫曼编码）
    5. 其他处理任务，联合直方图（概率）：条件熵、联合熵、互信息、广义熵等进行图像的复原、匹配以及目标识别。

    - 直方图均衡化
        - 这个考试会考，下面会说明
    - 直方图匹配（规定化）
        - 均衡化可以自己确定处理函数，而匹配（规定化）是要求处理后的直方图能有特定的形状。该处理方法似乎不要求掌握。
    - 局部直方图处理
        - 相比以上全局方法，该方法主要适用于图像的小区域细节。小区域细节区域中的影响在直方图中的体现很小，全局计算时可能被忽略，解决方法就是以图像的每个像素的邻域中的灰度分布为基础设计变换函数。

4. 灰度直方图能获取哪些信息？

    （归一化的）灰度直方图提供的信息是每个灰度级在图像中出现的概率。根据图形的直方图分布可以了解到这张图片的灰度动态范围，亮度分布，对比度等

5. 直方图均衡化基本步骤

    - ==TODO: 有空就写==

6. 给定指定直方图，计算均衡化后结果（灰度分布）

    - ==同上==

7. 利用平滑滤波的时候虽然能抑制噪声但是也模糊了细节，有哪些方法可以改善（减小模糊程度）？

    均值滤波过程中对所有的点都是同等对待，因此可能会导致图像变得模糊，在将噪声平均化的过程中，景物的边界点也与周围发生了均匀化。改善效果可以采用**加权平均**的方法来构造滤波器。

8. 中值滤波

    均值滤波器导致图像模糊是不能被完全消除的，加权改善效果也是有限的。因此设计中值滤波器，对于椒盐噪声来说，都是区域内最亮或最暗的点，因此可以取整个邻域内灰度级处于中间级的像素的值来代替这个位置的值。

    这样的操作可以有效去除噪声。

    - 统计排序滤波器
    - 

9. 图像锐化

    锐化的目的主要是突出图像中的细节，边缘或轮廓，因为边缘和轮廓都位于灰度突变的地方，所以锐化算法的实现是基于微分的。

    但是图像的微分可以突出其他突变，例如噪声，还会削减灰度变化缓慢的区域（低频区域）。

    最简单的锐化空间滤波器是基于掩膜操作的高通空间滤波器，一阶和二阶微分算子。

10. 一阶微分（及其算子），二阶微分（及其算子）

   一阶微分的表达式是

   $$\frac{\partial f}{\partial x}=f(x+1)-f(x)$$

   可以认为算子是$$(-1,1)$$

   *无视方向的条件*

   科学一些的写法是

   $$\triangledown f = grad(f)=\left[\begin{matrix} g_x\\ g_y \end{matrix}\right]=\left[\begin{matrix} \frac{\partial f}{\partial x}\\ \frac{\partial f}{\partial y} \end{matrix}\right]$$

   一阶微分的处理往往是利用**梯度的幅值**进行处理的，但是对幅值的应用方式有所不同，得到的最终算子也不尽相同。例如交叉差分等。具体算子如下

   $$Roberts: \left[ \begin{matrix}-1 & 0 \\ 0 & 1 \end{matrix} \right],\left[ \begin{matrix}0 & 1 \\ 1 & 0 \end{matrix} \right]$$

   $$Sobel: \left[ \begin{matrix}-1 & -2 &-1 \\ 0 & 0 & 0\\ 1 & 2 & 1 \end{matrix} \right],\left[ \begin{matrix}-1 & 0 & 1 \\ -2 & 0 & 2\\ -1 & 0 & 1 \end{matrix} \right]$$



   二阶微分的表达式是

   $$\frac{\partial^2 f}{\partial x^2}=f(x+1)+f(x-1)-2f(x)$$

   同理可以认为算子是$$(1,-2,1)$$

   - 一阶微分通常会产生较宽的边缘
   - 二阶微分对细节有较强的响应，例如细线、孤立点、噪声等
   - 一阶微分对灰度阶梯有较强的响应
   - 二阶微分对灰度阶梯变化产生双响应
   - 二阶微分算子在灰度值变化相似的时候，对线的响应比阶梯强，对点的响应比对线强。总之变化剧烈性而言点>线>阶梯
   - **总结起来二阶微分增强细节的能力比一阶微分好。**

   如果要在多方向满足这个条件，就要引入拉普拉斯算子。

   各向同性的算子是拉普拉斯算子，其表达式为

   $$\triangledown^2 f=\frac{\partial^2 f}{\partial x^2}+\frac{\partial^2 f}{\partial y^2}=\left[ \begin{matrix}0 & 1 & 0\\ 1 & -4 & 1\\ 0 & 1 & 0\end{matrix} \right]$$

   常用的拉普拉斯算子还有其他形式，例如45度旋转不变性的

   $$\left[ \begin{matrix}1 & 1 & 1\\ 1 & -8 & 1\\ 1 & 1 & 1\end{matrix} \right]$$

   这个算子实际上是将对角加入了运算，即对于原来的拉普拉斯算子叠加了对角型算子

   $$\left[ \begin{matrix}1 & 0 & 1\\ 0 & -4 & 0\\ 1 & 0 & 1\end{matrix} \right]+\left[ \begin{matrix}0 & 1 & 0\\ 1 & -4 & 1\\ 0 & 1 & 0\end{matrix} \right]=\left[ \begin{matrix}1 & 1 & 1\\ 1 & -8 & 1\\ 1 & 1 & 1\end{matrix} \right]$$

   两个90度不变性的算子叠加得到一个45度不变性的结果。

   有时候也会采用相反的算子。

   拉普拉斯算子常用与图像的锐化，这也正是微分算子常用的地方。印刷业中常用的图像锐化处理过程是从原图中减掉一张平滑的图像得到模板，将该模板扩大k倍后叠加到原图像中就完成了锐化。实际上我们得到的模板就是图像中的边缘。

   使用一阶微分的例子是


## 第四章 频率域滤波

1. 图像二维傅里叶变换公式，分析傅里叶变换后的频率分量与空间域特征的联系。

    “周期信号都可以表示为谐波关系的正弦信号加权和”

    “非周期信号都可以用正弦信号的加权积分来表示”

    图像二维傅里叶变换公式为

    正变换

    $$\mathfrak{F}(u,v)=\int_{-\infty}^{\infty}\int_{-\infty}^{\infty}f(x,y)e^{-j2\pi (ux+vy)}dxdy$$

    逆变换

    $$f(x,y)=\int_{-\infty}^{\infty}\int_{-\infty}^{\infty}\mathfrak{F}(u,v)e^{j2\pi (ux+vy)}dudv$$

    对于数字图像而言，采用离散变换的形式

    $$\mathfrak{F}(u,v)=\sum\limits_{x=0}^{M-1}\sum\limits_{y=0}^{N-1}f(x,y)e^{-j2\pi (ux/M+vy/N)}$$

    $$f(x,y)=\frac{1}{MN}\sum\limits_{u=0}^{M-1}\sum\limits_{v=0}^{N-1}\mathfrak {F}(u,v)e^{j2\pi (ux/M+vy/N)}$$

    变换后的频率分量与空间域的变化快慢有联系。例如点、线、边缘等变化较快的细节都属于高频分量，而变化较缓慢的区域对应于低频分量。一般的数字图像低频信息都比较多。

    一般在一个方向上的信息，频谱上都处于该方向的垂直方向。

2. 用傅里叶变换的性质证明图像频域中心化处理的表达式

    二维傅里叶变换及其反变换在频域中沿$$u$$和$$v$$方向是无穷周期变化的，即有

    $$\mathfrak{F}(u,v)=\mathfrak{F}(u+k_1M,v+k_2N)$$

    和

    $$f(x,y)=f(x+k_1M,y)=f(x,y+k_2N)=f(x+k_1M,y+k_2N)$$

    其中$$k_1,k_2$$都是整数。

    周期性在基于DFT的算法的实现上是重要的特性。利用该特性我们常做的操作就是频域中心化处理。由于傅里叶变换存在变换关系$$f(x)e^{j2\pi(u_0x/M)} \Leftrightarrow \mathfrak F(u-u_0)$$

    带入特殊值，该关系还可以写作

    $$f(x)(-1)^k \Leftrightarrow  \mathfrak F(u-M/2)$$

    在二维变换中同理可得

    $$f(x,y)(-1)^{x+y} \Leftrightarrow \mathfrak F(u-M/2,v-N/2)$$

    这样的操作可以将图像的低频分量集中在图像中。一张图像中的能量主要集中在低频区，这样处理可以便于观察。

3. 图像频率域滤波的基本步骤

    - 对图像进行补零操作，得到$$2M×2N$$的填充图像$$f_p(x,y)$$，避免缠绕（这里是啥意思我也没搞懂，好像是在0交叉位置通过填充来避免振铃出现）
    - 中心化变换，和前面说过的一样，图像乘$$(-1)^{x+y}$$
    - 对图像做DFT将得到$$\mathfrak F(u,v)$$，对乘因子后的图像做DFT将得到中心化的频谱$$\mathfrak F(u-M/2,v-N/2)$$
    - 用滤波器$$H(u,v)$$与变换后的结果相乘将得到$$\mathfrak G(u,v)$$
    - 计算结果的IDFT，得到$$IDFT[\mathfrak G(u,v)]$$
    - 将上述结果取实部，得到$$Re\{ IDFT[\mathfrak G(u,v)] \}$$
    - 再将结果乘$$(-1)^{x+y}$$，获得变换后的结果$$g_p(x,y)$$。
    - 将结果从左上截取$$M \times N$$区域，获取结果$$g(x,y)$$。

4. 写出三种频率域平滑（低通）滤波器，并分析各自的特点、截止频率的影响

    - 理想低通滤波器。以原点为中心，以$$D_0$$为半径的圆内，无衰减地通过所有频率分量，而在其之外完全衰减所有频率分量。频域表达式这里不再给出。这样的锐截止滤波器物理不可实现。由于频域锐截止，因此空间域是sinc的形状，在应用平滑滤波时相当于卷积sinc函数，因此会有较为明显的振铃。一般来说截止频率越低越容易出现肉眼可分辨的振铃，这与理想低通滤波器的傅里叶变换规律有关。
    - 巴特沃斯型，频域函数的形式为$$H(u,v)=\frac{1}{1+\beta \left[  \frac{D(u,v)}{D_0} \right]^{2n}}$$，其中$$\beta$$是一个系数，其取值用于定义滤波器在截止频率处的增益。巴特沃斯型在截止时不会出现明显的急剧不连续性，一般认为50%衰减处为截止频率，也正是由于这种平滑过渡，处理时不会出现明显振铃现象。当然随着阶数升高，巴特沃斯型也会出现一定的振铃，当阶数足够高的时候，可以认为BLPF会逼近ILPF。随着截止频率的降低，图像变得更加模糊。
    - 基于高斯函数的滤波器 $$H(u,v)=e^{-D^2(u,v)/2\sigma^2}$$，当取$$\sigma = D_0$$时，j截止频率$$D_0$$处滤波器下降到最大值的$$e^{-0.5}$$。高斯滤波是没有任何振铃的（牛逼！！！！【破音），常用与数据的处理，例如将断裂文字连接、人皮肤的表面磨皮、卫星图像模糊细节减少特征简化图像等。

5. 写出三种频率域高通滤波器，并分析各自的特点

    - 理想高通滤波器，和理想低通的定义恰好相反，理想高通滤波器在截止频率以外全通，但在截止频率内表现为锐截止，全不通。一般采用分段形式进行描述。同样的物理不可实现。理想高通一样会产生振铃现象，其原因和理想低通相同。
    - 巴特沃斯型高通，$$H(u,v)=\frac{1}{1+\left[ \frac{D_0}{D(u,v)} \right]^{2n}}$$，从表达式来看就是把低通形式反过来写了而已。实际使用中，巴特沃斯型要更加平滑，低阶时不易产生振铃，高阶逼近理想滤波的形式。
    - 高斯型高通，$$H(u,v)=1-e^{-D^2(u.v)/2D_0^2}$$，也是将高斯型表达式反过来写。高斯型的边缘最为平滑，即使对微小物体和细线的处理也是平滑的，一定不会出现振铃，一般也取标准差为截止频率。

6. 用傅里叶变换的性质证明**空间锐化滤波器拉普拉斯算子**在频域是高通滤波器

    拉普拉斯算子的空间域表示形式为

    $$\triangledown^2 f(x,y)=\frac{\partial^2 f}{\partial x^2}+\frac{\partial^2 f}{\partial y^2}$$

    利用傅里叶变换法则将上述结果做傅里叶变换得到

    $$\mathfrak F\left[ \frac{\partial^2 f}{\partial x^2}+\frac{\partial^2 f}{\partial y^2} \right]=-4\pi^2 (u^2+v^2)F(u,v)$$

    可以取前一部分为算子，因此频域拉普拉斯算子在实现时，传递函数可以写作$$H(u,v)=-4\pi^2 (u^2+v^2)$$，这是一个典型的调和函数表达式，进行绘制比较容易发现是高通形式。将该频域形式进行傅里叶反变换，得到算子的空间域形式，对空间域形式进行简单的近似将得到如下算子

    $$\left[ \begin{matrix}0 & 1 & 0\\ 1 & -4 & 1\\ 0 & 1 & 0\end{matrix} \right]$$

    该算子为微分算子，用于锐化增强细节，是高通的特点。至此显然可以说，拉普拉斯算子是一个高通算子。

7. 同态滤波过程、低通滤波器的目的是什么

    同态滤波过程前面已经说过了，但是不怕麻烦的我决定再说一遍。同态滤波的**目的**在于消除不均匀照度影响，增强图像细节。

    物理过程产生的图像，其灰度值应正比于物理源的辐射能量，而辐射能量由照射分量和反射分量合成，即前面说的

    $$f(x,y)=i(x,y)r(x,y)$$

    单位是流明（照度）。一般来说，反射分量表示图像的内容，随图像的细节不同在空间上快速变化，照射分量一般在空间是缓慢变化的，因此认为照射分量频谱落在低频区域，而反射分量的频谱集中在高频区域。但是乘性量是傅里叶变换不可分的，因此不能直接处理。处理乘性变化的方式为

    $$ln(i(x,y)r(x,y))=ln(i(x,y))+ln(r(x,y))$$

    分离了乘性量后就可以进行分别处理了。设计一个频率域滤波器，将结果与对数形式相乘并做反变换，然后用exp恢复原有scale就可以了。一般的，为了达到同态滤波的**目的**，往往采用高频增强滤波器，能够减少低频（照度），增强高频（反射），压缩动态范围，增强对比度。

8. 给定模板计算卷积

    空间域卷积就加权乘积就完事了，如果需要边框补充就补充，注意看条件（例如题目说“利用边缘复制方法”）。

## 第五章 图像的复原与重建

1. 写出图像在空间域和频率域的退化数学模型表达形式，并分析退化的原因

    **图像退化**是指由于成像系统受到各种因素的影响，在获取和传输的过程中图像降低的现象，其数学模型表达形式为

    **这里应该有框图**

    原空间域数字图像经过退化函数H以及加性噪声后得到另一空间域图像，很容易用表达式来表示（空间域和频域）

    $$g(x,y)=h(x,y)\circledast f(x,y)+\eta(x,y)$$

    $$G(u,v)=H(u,v)F(u,v)+N(u,v)$$

    **这两个公式是图像复原大部分内容的基础。*

    而复原过程就是使用一个复原滤波器使得图像在某种判定标准下达到最优估计。

    一般来说退化原因有

    - 成像系统的散焦
    - 成像设备与物体间的相对运动（飞行器拍摄、摄像车、运动机械臂，导轨，手抖动等）
    - 成像器材的固有缺陷（加工精度、边缘部分畸变）
    - 外界环境——噪声、干扰（大气湍流对航空卫星测控遥感等成像的影响）

    从另一角度来分析，

    - **获取过程**：由于光学成像系统的像差、衍射、非线性畸变、散焦、感光元器件的非线性、成像过程的相对运动、大气湍流、环境随机噪声等原因导致图像质量下降。
    - **传输过程**：由于传输信道干扰而造成图像质量下降。

    图像的复原一般就用于修复这类问题。

2. 带噪图像空间域复原复原方法：均值滤波、统计排序滤波

    噪声来源是采集过程和传输过程，成像过程、数字化过程、信道干扰等。为简化问题，假设噪声与空间和图像都无关。仅仅由于噪声导致图像退化时，退化方程简化为

    $$g(x,y)=f(x,y)+\eta(x,y)$$

    $$G(u,v)=F(u,v)+N(u,v)$$

    由于噪声种类很多，来源不定，所以不能直接采用减掉噪声的方法（以高斯噪声为例，减掉一个随机高斯噪声相当于又加了一个一样的高斯噪声。）

    一般方法是空间域滤波，常用均值滤波器、顺序统计滤波器和自适应滤波器等。

    **均值滤波器**

    - 算术平均滤波器，$$\widehat{f}(x,y)=\frac{1}{mn}\sum\limits_{s,t}g(s,t)$$，滤除噪声的同时会导致图像的模糊。
    - 几何平均滤波器，$$\widehat{f}(x,y)=\left[ \prod\limits _{s,t}g(s,t)\right]^\frac{1}{mn}$$，平滑程度与算术平均相当，但是可以保留更多细节（几何平均算出来的点可能比实际原数值大，因此说保留更多细节），对黑色物体有扩大作用（邻域内出现一个0就会导致该像素点变成0）
    - 谐波平均滤波器，$$\widehat{f}(x,y)=\frac{mn}{\sum\limits_{s,t}\frac{1}{g(s,t)}}$$，对盐粒噪声效果要好，不适应于胡椒噪声，对高斯噪声有比较好的效果。
    - 逆谐波平均滤波器，$$\widehat{f}(x,y)=\frac{\sum\limits_{s,t}g(s,t)^{Q+1}}{\sum\limits_{s,t}g(s,t)^Q}$$，适用于两种噪声，但是不能同时使用。Q>0时用于消除胡椒噪声，Q<0时用于消除盐粒噪声，Q=0时是算术平均滤波器，Q=1时为谐波平均滤波器。

    **统计排序滤波器**

    - 中值滤波器：$$\widehat{f}(x,y)=median\{g(s,t)\}$$，对单极噪声以及双极脉冲噪声非常有效。
    - 最大值滤波器：$$\widehat{f}(x,y)=max\{g(s,t)\}$$，用于过滤胡椒噪声，因为选用的是邻域最亮点。
    - 最小值滤波器：$$\widehat{f}(x,y)=min\{g(s,t)\}$$，用于过滤盐粒噪声，原因同理。
    - 中点滤波器：$$\widehat{f}(x,y)=\frac{1}{2}\left[max\{g(s,t)\}+min\{g(s,t)\}\right]$$，用于过滤高斯和均匀随机噪声
    - 修正的$$\alpha$$滤波器：$$\widehat{f}(x,y)=\frac{1}{mn-d}\sum\limits_{s,t}g_d(s,t)$$，其中$$g_d$$为去除最高灰度值的$$d/2$$个点以及最低灰度值的$$d/2$$点后得到的剩余像素。对剩余像素做平均将得到适应多种噪声的滤波器。d=0时就是算术平均，而d=mn-1时就是中值滤波器，d去其他值适用于包含多种噪声的环境，例如高斯混合椒盐。

    **自适应滤波器**



    处理基于$$m\times n$$的**局部窗口**的区域内图像的统计特性，相比其他滤波器可以达到更优效果，但是算法更加复杂。

    $$\widehat{f}(x,y)=g(x,y)-\frac{\sigma_\eta^2}{\sigma_L^2}[g(x,y)-m_L]$$

    其中$$\sigma_\eta^2$$是噪声方差，$$\sigma_L^2$$是局部方差，$$m_L$$是局部算术平均值。

    - 如果噪声方差为0，则保留原灰度值不作处理；

    - 如果噪声方差小于局部方差，可以说是局部方差与噪声方差高度相关，则返回一个$$g(x,y)$$的近似值，是$$g(x,y)$$与$$m_L$$的加权。
    - 如果噪声方差与局部方差相等，则返回均值以降低局部噪声。

    但是这里的噪声方差是需要预先知道会估计的。自适应法的效果优于算术法、几何均值法，保留细节更好，但代价是复杂性高，实时性差，平滑作用更强。

    上述滤波器是自适应局部降噪滤波器，实际应用中还有自适应的中值滤波器。相比传统中值滤波器只能处理空间密度不大的冲激噪声，而自适应中值滤波可以处理更大概率的冲激噪声。可以在平滑非冲激噪声（例如高斯）时保留更多细节。但主要目的仍是去除椒盐噪声、平滑其他非冲激噪声并减少物体边界细化或粗化的失真。步骤如下

    A：找到一个非脉冲中值

    ​	$$A_1=z_{med}-z_{min}$$，$$A_2=z_{med}-z_{max}$$。如果前者为正，后者为负，则认为中值不是脉冲，转到B，否则加大窗口尺寸重复A操作，直到达到最大允许窗口尺寸。此时直接输出$$z_{xy}$$（书上写的$$z_{med}$$）。

    B：判断中心像素是否为脉冲

    ​	$$B_1=z_{xy}-z_{min}$$，$$B_2=z_{xy}-z_{max}$$。如果前者为正后者为负，认为中心像素不是脉冲，则输出$$z_{xy}$$；否则该点是脉冲，输出$$z_{med}$$，因为A中已经判断了$$z_{med}$$不是脉冲。

3. 自适应滤波器为什么有更好的处理效果？

    因为自适应滤波器处理时会基于$$m\times n$$的局部窗口区域内图像的统计特性进行处理，而其他滤波器不会考虑局部特性。

    代价是复杂度提高。

    另外目前为止讨论的退化都还是原图像叠加噪声而已。

4. 如何去除图像中的周期噪声？带阻、陷波、最佳陷波

    用于复原的频率域滤波器有带阻、带通、陷波、最佳陷波。

    - 带阻滤波器

        一般来说，用于选频阻止的带阻滤波器，除去周期噪声时倾向于向选择阻带较窄的滤波器（如高斯），这样就可以保持图像的更多的细节。

        - 理想带阻，就很简单的阻止一定频段的频率分量，由于是理想的，因此截止频率处都是锐截止，在通带中全通，阻带中全阻。可以除去一定频率全方向的周期噪声。但是有可能因此影响到该频段的其他内容。
        - 巴特沃斯带阻，表达式为$$H(u,v)=\frac{1}{1+\left[  \frac{D(u,v)W}{D^2(u,v)-D^2_0} \right]^{2}}$$。
        - 高斯带阻，表达式为$$H(u,v)=1-e^{-\frac{1}{2}\left[\frac{D^2(u,v)-D^2_0}{D(u,v)W}\right]^2}$$。

    - 带通滤波器，其实就是$$H_{bp}=1-H_{br}$$。

    - 陷波滤波器，事先选定了频谱中的频率中心，因此阻带（或通带）很小，选频能力很强，一般说Q值较高。由于傅里叶变换是对称的，因此陷波滤波器都是以对称点为单位出现的（除了原点）。当然数量就可以自己选定了。

    - 最佳陷波滤波器。当干扰较多的时候就不适合使用陷波滤波器了，因为干扰过多就容易消除太多的图像信息，另外干扰成分通常不是单频率脉冲，而是携带干扰模式信息的宽边缘，我们将复原估计值的局部方差最小化时，认为方案是最佳的。

        - 提取干扰模式的主频率成分，可以在每一个尖峰位置放置一个陷波滤波器。则我们可以获取空间域表达式为

            $$\eta(x,y)=\mathfrak F^{-1}\{ H(u,v)G(u,v) \}$$

            仍然假设是加性噪声，这时候我们从原图像中减掉噪声就可以达到目的，即

            $$\widehat f(x,y)=g(x,y)-w(x,y)\eta(x,y)$$

            现在要优化$$w(x,y)$$使结果达到最优。一种优化方式是选取一个使$$\widehat f$$在指定邻域中的方差最小。

        - 局部方差估计

            $$\sigma^2(x,y)=\frac{1}{(2a+1)(2b+1)}\sum\limits_{i=-a}^{a}\sum\limits_{j=-b}^{b}\left[ \widehat f(x+i,y+j)-\overline {\widehat{f}}(x,y) \right]^2$$

            其中平均值表达式为

            $$\overline {\widehat{f}}(x,y) =\frac{1}{(2a+1)(2b+1)}\sum\limits_{i=-a}^{a}\sum\limits_{j=-b}^{b} \widehat f(x+i,y+j)$$

            将上述的两个式子联立可以得到

            $$\sigma^2(x,y)  =\frac{1}{(2a+1)(2b+1)}\sum\limits_{i=-a}^{a}\sum\limits_{j=-b}^{b}\left[g(x+i,y+j)- \\   w(x+i,y+j)\eta(x+i,y+j)-\left[\overline {g}(x,y) - \overline{w(x,y)\eta(x,y)}\right] \right]^2 $$

            考虑到$$w(x,y)$$在邻域中基本不变，则有

            $$\overline{w(x,y)\eta(x,y)}=w(x,y)\overline{\eta}(x,y)$$

            带回原式求解最小化局部方差时得到

            $$\frac{\partial \sigma^2(x,y)}{\partial w(x,y)}=0$$

            结果得到

            $$w(x,y)=\frac{\overline{g(x,y)\eta (x,y)}-\overline{g}(x,y)\overline{\eta}(x,y)}{\eta^2(x,y)-\overline{\eta}^2(x,y)}$$

5. 估计退化函数的一般方法有哪些？观察估计、试验估计、建模

    - 观察估计。都说了估计还能怎么办。从强信号（高SNR）区域尝试退化估计，对子图像的复原成功后再将模型应用于整个图像。

        $$H(u,v)=\frac{G_s}{\hat{H}_s}$$

    - 试验估计。也是估计。可以采用相似的退化图像获取设备，建立理论上近似准确地退化函数估计。利用相同的系统设置，对一个脉冲成像，一般来说得到的结果应该是一个常数A，

        $$H(u,v)=\frac{G(u,v)}{A}$$。

    - 模型估计。最常见的离子是航空图像受到大气湍流影响的建模。其退化的数学模型是$$H(u,v)=e^{-k(u^2+v^2)^{5/6}}$$，其中k是常数，而且是一个类似高斯低通的形式，也会导致图像的模糊。根据流速不同可以选择不同的k一般流速越高k越大。


    对于有先验知识的图像，我们可以直接直到退化过程，进而设计复原函数。对于没有先验知识的图像，则需要依靠上述后验方法对图片本身进行估计。一般是观察图像中有特征的部分。

6. 建模估计中，如果传感器与物体之间做相对的匀速直线运动，给出退化函数

    传感器与景物之间相对运动，假设快门时间T，x和y分别为位移分量，则生成图像为

    $$g(x,y)=\int_0^T f\left[x-x_0(t),y-y_0(t)\right]dt$$

    对生成图像做傅里叶变换得到

    $$G(u,v)=F(u,v)\int_0^T e^{-j2\pi[ux_0(t)+vy_0(t)]}dt$$

    则退化函数就可以写作

    $$H(u,v)=\int_0^T e^{-j2\pi[ux_0(t)+vy_0(t)]}dt$$

    对于匀速直线运动我们有

    $$x_0(t)=at/T,y_0(t)=bt/T$$

    代入原式积分得到

    $$H(u,v)=\frac{T}{\pi (ua+vb)}sin[\pi(ua+vb)]e^{-j\pi(ua+vb)}$$

    其实还有点扩散退化函数和高斯退化函数等常见的退化函数。

7. 由退化函数复原原图像的方法有？逆滤波、最小均方误差（维纳）滤波、约束最小二乘滤波（简单了解这些即可）。

    已知退化函数，常用的方法有

    - 逆滤波，已知$$g=Hf+\eta,\eta=g-Hf$$，在对噪声没有先验知识的情况下，寻找$$f$$的估计$$\hat{f}$$，使得最小均方误差准则下最近接$$g$$，需要使$$\eta$$的范数误差最小，则优化$$J(f)=\mid \mid g-Hf \mid \mid^2$$，求出

        $$\hat f = H^{-1}g$$。

        实际上就$$\hat f(x,y)=\mathfrak F^{-1}[G(u,v)/H(u,v)]$$

        但在已知噪声的条件下，即使是完全知道了退化函数也不能完全恢复原始图像，因为存在一个噪声量，其傅里叶变换的形式未知。当H较小时会导致不稳定解，N/H的比值极大，因此放大噪声项。这时无约束图像复原模型的病态性。

    - 维纳滤波（最小均方误差滤波）

        维纳滤波是寻找一个滤波器使$$e^2=E\{ (f-\hat f)^2 \}$$

        这里需要假定噪声和图像无关，均值为零，且估计图像的灰度级是退化函数灰度级的线性函数，那么上式通过最小化误差函数得到的$$\hat f$$在频域表现为

        $$\hat F(u,v)=\left[ \frac{1}{H(u,v)·\frac{\mid H(u,v)\mid^2}{\mid H(u,v)\mid^2 + \frac{S_\eta(u,v)}{S_f(u,v)}}} \right]G(u,v)$$

        括号内的部分被称为复原传递函数，或者最小均方误差滤波器。如果噪声为0，原式退化为

        $$\hat F(u,v)=\left[ \frac{1}{H(u,v)·\frac{\mid H(u,v)\mid^2}{\mid H(u,v)\mid^2 + K}} \right]G(u,v)$$

        可以通过调整K来实现最佳视觉效果。

        - 当无噪声或噪声极小的时候，原表达式的形式近似于逆滤波。
        - 噪声较大的时候，维纳滤波器趋向于0，表现出了对噪声的极大抑制。
        - 对于衍射受限光学系统，截止频率之外的H为0，但是由于两个功率项的存在，维纳滤波器的值始终不为0。

    - 约束最小二乘方滤波

8. 逆滤波时，为什么在图像存在噪声的时候不能选择全滤波？试采用逆滤波原理说明，并给出正确处理方法

## 第六章 彩色图像处理

1. 图像的彩色模型解释，RGB、CMYK、HSI等的含义及应用
2. 什么是伪彩色图像处理？目的是什么？试列举伪彩色处理的主要方法
3. 在彩色图像处理中常采用HSI模型，适用于图像处理的原因是什么
4. 解释HSI模型的含义

## 第八章 图像压缩

1. 图像压缩中主要数据冗余是什么？列举常见的图像压缩格式
2. 霍夫曼编码是什么？计算下列编码中的编码效率，压缩率、冗余度、信息熵
3. 算术编码
4. 离散余弦变换的表达式和基于DCT块编码系统实现的主要步骤，并对每一步作简要说明

## 第九章 形态学图像处理

1. 腐蚀和膨胀操作，简答原理或实现，说明主要特点及应用
2. 开操作和闭操作，同上
3. 采用指定结构元素对指定图形做膨胀操作

## 第十章 图像分割

1. 解释图像分割的应用，图像分割是基于灰度的什么特征实现的？
2. 一阶、二阶导数对图像的灰度特征是如何响应的？
3. 边缘检测（Sobel，Prewitt，Roberts，Laplace算子）。给出模板并分析功能
4. 高级复杂的边缘检测算法：Marr-Hildreth（LOG）和Canny算子实现步骤、特点和应用，给出主要步骤的数学模型。
5. Hough变换检测直线
6. 简述门限（阈值）分割图像的基本思路，自动全局阈值应该如何选取？



- 综合题目中模板大小3×3，图像矩阵一般是4×4或5×5，计算之外还要求对模板的作用进行分析。





## Extra - 数字图像处理课程设计 - Style Transfer

传统数字图像处理是针对图像的传统特征进行增强或修改，这些特征往往是人为设定的。基于CNN的图像处理实际上也是针对特征的处理，但是特征与传统的特征不同。CNN中的卷积核一般是需要网络自行优化的，与人为设计相比，在不同的处理任务中，卷积核可能并不相同，也不需要人为额外设计。

### 1. CNN 模型

#### 1.1 CNN的历史

- CNN最早可以追溯到1968年，Hubel和Wiesel发表了一篇论文，文中讲述了猫和猴的视觉皮层中含有对视野的小区域单独反应的神经元。文中提出的**感受野**概念为CNN的局部感知奠定了基础。
- 1980年神经感知机出现，标志着第一个初始的卷积神经网络诞生。神经感知机将一个视觉特征分解成许多子特征，通过分层递接相连的特征平面进行处理。
- 上世纪的发展始终较为缓慢，受限于数据量与计算力，大多数进展仅仅局限于理论
- 2005年左右，人们利用GPU实现了CNN的加速运算，一种使用专用加速的CNN处理方式出现，从而使得CNN重新发展，深度学习也进入了大众视野。
- 2012年ImageNet大赛中，CNN首次夺得冠军，并大幅超越其他算法

#### 1.2 CNN基本结构

CNN由输入层、输出层以及多个隐藏层组成。这个结构和传统的nn结构相同，通过输入层将数据送入网络，网络中进行运算后从输出层输出。中间的隐藏层一般包括卷积层、池化层、ReLU层和全连通层。从我个人理解，**卷积层**使用类似卷积的方式减少运算参数，并抽取图像的信息，**池化**实际上是一个降采样，也分很多种；**ReLU**是线性整流单元的缩写，与此相关的是机器学习中的一些非线性函数。其他类似的函数还有`Sigmoid`，`tanh`等，此处不再介绍其性质。经过试验验证、理论证明，可以知道ReLU在处理此类问题上不仅高效而且效果较好；**全连通层**作用其实是线性变换。

数字图像可以理解为一个矩阵，拥有多个通道的彩色图像就是一个张量。TensorFlow的取义就是张量流，数据都是以张量形式在网络中流动的，因此张量可以作为网络的输入。

图像经过输入层后来到隐藏层。首先介绍卷积层。

- 卷积层是CNN的核心，卷积层可以理解为是一组可以被训练的滤波器组。卷积层一般有较小的感受野，常见的卷积核也就3×3或5×5，在VGG的一些模型中还出现过1×1的卷积核作特殊用途。在网络的前馈过程中，卷积核对图像进行卷积，然后将结果进行输出（有时会通过激活函数后输出）。

    实际上图像的卷积有相关的含义，与我们课程中的相关运算很像，我们可以理解为卷积过程在进行相关匹配，以此来提取更高层次的特征。例如我们使用的`Sobel`算子，就会匹配与算子相似的特征。

- 池化层的目的就是下采样，降低数据量的方式。数字图像中数据量较多，通过池化的方法降低数据量，实际还可以让滤波器匹配更大的特征（降低了图像的特征尺寸）。常见的池化方式有最大池化`max_pooling`，工作方式如图。

    ![](https://raw.githubusercontent.com/psycholsc/psycholsc.github.io/master/assets/maxpooling.png)

    本次按照论文所述，将采用平均池化，即对每个窗内的像素求平均值。

- ReLU线性整流单元，在《随机信号分析》中学到过，是一种非线性元件/函数。实际曲线如图

    ![](https://raw.githubusercontent.com/psycholsc/psycholsc.github.io/master/assets/ReLU.png)

    主要作用在于添加非线性量。

- 输出层，一般对于分类器模型，会采用$$Softmax$$等函数作为输出层，用于将结果转化为决策数值。也有直接输出结果的，本次就采用直接输出。

- 全连通层，常规神经网络，就相当于对图片应用一定维度的矩阵线性变换。

#### 1.3 CNN的特点

1. 局部感知
    - 卷积核大小固定，因此感知区域有限。提升感知能力（**由局部到整体**）通过池化和全连通层完成。
    - 传统的nn结构只能对整体作分析
2. 权重共享
    - 传统nn的参数量巨大。如果对一张1000\*1000的图像作分析，想要映射到和原图相同大小的矩阵中，根据全连接的定义，将需要1000\*1000\*1000\*1000个参数，运用卷积的方法可以有效降低参数的数量。
3. 多卷积核
    - 每个卷积核可以代表一种特征，如果采用多卷积核，就能获取不同特征的集合。

### 2 Neural Style

#### 2.1 思路

论文1508.06576v2（ArXiv）,**A neural algorithm of artistic style**,发表于CVPR16时有修改，题目为**Image Style Transfer Using Convolutional Neural Networks**，内容大体相似。

该算法在2016年时大受推崇，**结果直观**，**理论简介**，且**容易**在各种平台**复现**。本次采用`TensorFlow`进行复现。

本算法实现的思路为

1. 使用**现成**的**识别网络**，提取图像的不同层级的特征
2. 低层的响应描述了图像的**大体风格**，高层次的响应描述了图像的**内容**。
3. 采用梯度下降方法优化**输入响应**，使得我们在特定层获取特定响应。
4. 经过足够次数的迭代，输入响应就获得了特定的风格与内容。

如果说mnist拥有五层卷积层和三层全连接层只是一个简单的机器学习任务，那不得不说，本项目的实现是依赖了如假包换的**深度学习**。

#### 2.2 VGG

基于深度卷积神经网络的图像识别模型很多，例如GoogleNet、LeNet等，此处选择的VGG模型也是其中的一种。VGG取义`Oxford Visual Geometry Group`，隶属于1985年成立的机器人研究组，这个模型实际上与传统的CNN模型并无较大差异（或者说就是一个较为复杂的CNN模型）。在图像分类比赛中获取过较好的成绩。其模型的结构为

![](https://raw.githubusercontent.com/psycholsc/psycholsc.github.io/master/assets/VGG.png)

#### 2.3 响应（内容）逼近

对于每一个网络层，实际上输出结果可以表示为

$$x_{t+1}=f(Wx_t+b)$$

其中网络的权重为$$W$$，$$x_t$$是前一层的输出，$$x_{t+1}$$是当前层的输出。论文中指出，这个池化采用了average_pooling，据说可以略微提升效果。

这个(pretrained) VGG网络是现成的、训练好的，不需要我们做额外的操作就能够在低层级输出图片的小区域的信息（边角、曲线），中间层输出较大尺度的信息（方块、螺旋），高层级输出最大尺度的信息（图片的总体内容信息）

接下来需要调教网络的响应。将这个网络视为一个系统（非线性系统）

**任取一个图像**$$X^0$$，将其输入上述的网络中，第$$l$$卷积层的响应我们记为$$X^l$$，其尺寸为$$H^l \times  W^l \times N^l$$。H是该层输出的高度，W是该层输出的宽度，N是滤波器组的数量。

即对于输入$$X^0$$，得到系统响应为$$X^l$$。

对于我们的**目标图像**$$\overline{X^0}$$，送入同样的网络，同样可以得到第$$l$$层响应为$$\overline{X^l}$$。

即对于输入$$\overline{X^0}$$，得到系统响应为$$\overline{X^l}$$。

如果我们希望调整系统的输入，使得两个输入变得相似，一个可行的方法就是调整其响应。视**确定风格**的图像的响应为固定值，修改目标图像的响应，就可以让目标图像在某种程度上接近**风格图像的风格**。

这个调整过程是神经网络优化算法中常见的反向传播方法。假设我要调整第$$l$$层的误差，我们就可以设计范数误差函数

$$E_c^l=\frac{1}{2}\mid \mid X^l-\overline{X^l}\mid \mid ^2$$

有关梯度下降法的相关内容可以看CS229那一篇文章的介绍。

用此图辅助理解

![](https://raw.githubusercontent.com/psycholsc/psycholsc.github.io/master/assets/mnistCNN.png)

进一步的，运用链式求导法则，将误差反向传播到输入层，整个过程就是反向传播。

*通过第一次求导，可以得出前一层的误差，第二次求导获取更前一层的误差，通过多次的链式求导，就能求得最前一层的误差，我们按照梯度方向进行修正，就能让输入图像的==内容==更加接近。*

#### 2.4 风格逼近

风格是没有位置关系的。

**格拉姆矩阵**（Gram Matrix），协方差矩阵。格拉姆矩阵的定义为

$$\Delta (\alpha_1,\alpha_2,...,\alpha_k)=\left[ \begin{matrix}(\alpha_1,\alpha_1) & (\alpha_1,\alpha_2) & ... & (\alpha_1,\alpha_k)\\ (\alpha_2,\alpha_1) & (\alpha_2,\alpha_2) & ... & (\alpha_2,\alpha_k)\\ ...&...&...&... \\ (\alpha_k,\alpha_1) & (\alpha_k,\alpha_2) & ... & (\alpha_k,\alpha_k)\end{matrix} \right]$$

其中括号表示内积。

实际上可以用来判断特征之间的偏心协方差（未减去均值的协方差矩阵）。论文中采用Gram矩阵为

$$G_{i,j}^l=\sum\limits_{hw}x_{j,w,i}^l · x_{h,w,j}^l$$

即第$$l$$层的格拉姆矩阵用作特征矩阵，由于计算方法抛弃了位置信息，因此可以看做是对风格的描述。第$$i,j$$位置的元素用于描述第$$i$$和第$$j$$个响应的相关性。这可以看作是一个图形风格的代表。

为了让风格像上面的内容一样得到近似，我们采用相似的方法进行逼近。

$$E_c^l=\frac{1}{2}\mid \mid G^l-\overline{G^l}\mid \mid ^2$$

对误差求导可以得到

$$\frac{\partial E_s^l}{x^l_{h,w,k}}=(X^l)^T(G^l-\overline{G^l})_{i,j}$$

同样通过反向传播法则可以使目标图像和我们选取的图像风格逼近。

![](https://raw.githubusercontent.com/psycholsc/psycholsc.github.io/master/assets/StyleExperiment.png)

#### 2.5 测试

为了不失一般性，采用高斯噪声作为初始输入图像，选取一幅特殊风格的图像作为参考。其中

代表了内容特征的卷积层选择$$conv4\_2$$

代表了风格特征的卷积层选择$$conv1\_1,conv2\_1,conv3\_1,conv4\_1,conv5\_1$$

设内容误差权重为$$\alpha$$，设风格误差权重为$$\beta$$，则误差函数可以联合为

$$Loss_{total} = \alpha Loss_{content}+\beta Loss_{style}$$

即

$$Loss_{total} = \frac{1}{2}\alpha \mid \mid X^l-\overline{X^l}\mid \mid ^2+\beta \frac{1}{2}\mid \mid G^l-\overline{G^l}\mid \mid ^2$$

以下是训练了100次后的结果，耗时约10分钟。

![](https://raw.githubusercontent.com/psycholsc/psycholsc.github.io/master/assets/1542695387.result.png)

使用GPU加强训练了2000次，得到结果对比如下

![](https://raw.githubusercontent.com/psycholsc/psycholsc.github.io/master/assets/LX.jpg)

*图取自 北京理工大学 良乡图书馆*

![](https://raw.githubusercontent.com/psycholsc/psycholsc.github.io/master/assets/1620.png)



原论文中没有提及缺陷，此处进行一定的说明

1. 只能获取某种类型的风格。风格判定矩阵（无视位置的格拉姆矩阵）与卷积网络（局部连接匹配）的特点就决定了只能提取线条和色调这样的特征
2. 此时的风格迁移算法还不能理解图像的含义，只能根据特征进行匹配。匹配时只能将本身内容相似的图像进行混合，否则需要进行细致调参（本模型的超参数超过10个），但效果仍不理想。
3. 对于低对比度图像生成效果变差。
4. 迁移效率较低。模型每一次迭代都在训练CNN中的参数，完成一次迭代需要更新参数很多。相比之下斯坦福大学提出的fast neural style只需要做一次前馈就能完成风格的迁移。

